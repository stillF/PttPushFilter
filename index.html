<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>stillF&nbsp;-&nbsp;Ptt推文</title>
    <link rel="stylesheet" type="text/css" href="/PttPushFilter/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="/PttPushFilter/css/fontawesome-all.css">
    <link rel="stylesheet" type="text/css" href="/PttPushFilter/css/select2.css">
    <link rel="stylesheet" type="text/css" href="/PttPushFilter/css/toastr.min.css">
    <script type="text/javascript" src="/PttPushFilter/js/jquery-3.3.1.min.js"></script>
    <script type="text/javascript" src="/PttPushFilter/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="/PttPushFilter/js/select2.js"></script>
    <script type="text/javascript" src="/PttPushFilter/js/toastr.min.js"></script>
</head>
<body>
    <header>
        <nav class="navbar navbar-inverse navbar-static-top" role="Navigation">
            <div class="container" style="width:100%">
                <div class="navbar-header">
                    <a href="https://stillf.github.io/" class="navbar-brand" style="color:#ffffff;margin-left:10px;" target="_blank">stillF&ensp;信柴柴，得第一</a>
                </div>
            </div>
        </nav>
    </header>

    <div class="container" style="width:100%">
        <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
            <div style="color:#333;font-size:22px;font-weight:bold;">
                Ptt推文
                <a href="https://github.com/stillF/PttPushFilter" style="margin-left:5px;" target="_blank"><i class="fas fa-link"></i></a>
            </div>
            <hr>
        </div>
        <div class="col-xs-12 col-sm-12 col-md-10 col-lg-10">
            <div class="panel panel-default">
                <div class="panel-heading">
                    搜尋
                </div>
                <div class="panel-body">
                    <label>ptt.cc 網址</label>
                    <div class="form-group input-group" style="margin-right:7px;">
                        <input type="text" class="form-control" name="pttUrl" id="pttUrl">
                        <span class="input-group-btn">
                            <button class="btn btn-default" type="button" onclick="cleanInput('pttUrl')"><i class="far fa-trash-alt"></i></button>
                        </span>
                    </div>
                    <label>id</label>
                    <div class="form-group input-group" style="margin-right:7px;">
                        <input type="text" class="form-control" name="pttID" id="pttID">
                        <span class="input-group-btn">
                            <button class="btn btn-default" type="button" onclick="cleanInput('pttID')"><i class="far fa-trash-alt"></i></button>
                        </span>
                    </div>
                    <button type="button" class="btn btn-primary btn-block" style="margin-top:10px;" onclick="searchPtt();">送出</button>
                </div>
            </div>
            <div class="panel panel-default" style="margin-top:35px;">
                <div class="panel-heading">
                    資料
                </div>
                <div class="panel-body">
                    <div id="resultArea"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="loadingModal" data-backdrop="static" data-keyboard="false">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title">Loading</h4>
                </div>
                <div class="modal-body">
                    <span id="loadingSpan" style="color:red;font-size:20px;font-weight:600;">## 資料查詢中，請勿重整視窗或是關閉視窗 ##</span>
                    <div class="progress" style="margin-top:10px;">
                        <div class="progress-bar progress-bar-danger progress-bar-striped" role="progressbar" aria-valuemin="0" aria-valuemax="100" style="width:20%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="navbar-inverse">
        <div class="container-fluid text-center">
            <p class="text-muted" style="margin-top:10px;color:#ffffff">© Copyright 2021. All Rights Reserved.</p>
        </div>
    </footer>

    <script type="text/javascript">
        function searchPtt() {
            $("#resultArea").empty();
            let _Ptturl = jQuery.trim($("#pttUrl").val());
            if (!isPttUrl(_Ptturl)) {
                toastr.error("「ptt.cc 網址」格式錯誤，請重新輸入。");
                return false;
            }

            $("#loadingModal").modal("show");
            let _pushData = [];
            let _userId = "";
            let _pushContent = "";
            let _searchIndex = -1;
            let _html = "";
            $.ajax({
                //url: 'https://cors-anywhere.herokuapp.com/' + _Ptturl,
                url: 'https://secret-ocean-49799.herokuapp.com/' + _Ptturl,
                dataType: 'html',
                success: function (data) {
                    if ($(data).find('.over18-notice p').length > 0) {
                        $("#resultArea").append("over18=1;");
                        return false;
                    }

                    let pushData = $(data).find('div.push');
                    let _length = pushData.length;
                    let _item = null;
                    for (i = 0; i < _length; i++) {
                        _item = $(pushData).eq(i);
                        _userId = jQuery.trim($(_item).find(".push-userid").text());
                        _searchIndex = _pushData.findIndex((obj => obj.userId === _userId));
                        if (_searchIndex !== -1) {
                            _pushContent = _pushData[_searchIndex]["pushContent"];
                            _pushContent += ($(_item).find(".push-content").text()).replace(": ", "") + "\n";
                            _pushData[_searchIndex]["pushContent"] = _pushContent;
                        } else {
                            _pushData.push({
                                userId: _userId,
                                pushContent: ($(_item).find(".push-content").text()).replace(": ", "") + "\n"
                            });
                        }
                    }

                    let _iMax = _pushData.length;
                    if (_iMax > 0) {
                        let searchPttID = jQuery.trim($("#pttID").val());
                        if (searchPttID === "") {
                            for (i = 0; i < _iMax; i++) {
                                _html += "<span># " + (i + 1) + "【" + _pushData[i]['userId'] + "】</span>";
                                _html += "<pre>" + _pushData[i]['pushContent'] + "</pre>";
                            }
                        } else {
                            _searchIndex = _pushData.findIndex((obj => obj.userId === searchPttID));
                            _html += "<span># 1【" + _pushData[_searchIndex]['userId'] + "】</span>";
                            _html += "<pre>" + _pushData[_searchIndex]['pushContent'] + "</pre>";
                        }
                        $("#resultArea").append(_html);
                    } else {
                        $("#resultArea").append("查無資料");
                    }
                },
                complete: function () {
                    $("#loadingModal").modal("hide");
                },
                statusCode: {
                    404: function () {
                        $("#resultArea").append("404 not found");
                    }
                }
            });
        }

        function isPttUrl(url) {
            if (!url.startsWith("https://www.ptt.cc/bbs/")) { return false; }
            if (!url.endsWith(".html")) { return false; }
            return true;
        }

        function cleanInput(inputName) {
            $("#" + inputName).val("");
        }
    </script>
</body>
</html>